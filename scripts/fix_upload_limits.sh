#!/bin/bash

# ============================================================
# ุณูุฑูุจุช ุฃุชูุชุฉ ุฅุตูุงุญ ุฅุนุฏุงุฏุงุช ุฑูุน ุงููููุงุช ูู PHP
# ูููู ุจุชุนุฏูู php.ini ุชููุงุฆูุงู ุจุงุณุชุฎุฏุงู sed
# ============================================================

set -e  # ุฅููุงู ุงูุชูููุฐ ุนูุฏ ุญุฏูุซ ุฎุทุฃ

# ุงูุฃููุงู
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# ุฑุณุงูุฉ ุงูุชุฑุญูุจ
clear
echo -e "${BOLD}${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BOLD}${BLUE}   ๐ง ุณูุฑูุจุช ุฅุตูุงุญ ุฅุนุฏุงุฏุงุช ุฑูุน ุงููููุงุช ูู PHP${NC}"
echo -e "${BOLD}${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

# ====================================
# ุงูุฎุทูุฉ 1: ุงูุนุซูุฑ ุนูู ููู php.ini
# ====================================
echo -e "${BOLD}๐ ุงูุฎุทูุฉ 1: ุชุญุฏูุฏ ูููุน ููู php.ini...${NC}"
PHP_INI=$(php --ini | grep "Loaded Configuration File" | cut -d: -f2 | xargs)

if [ -z "$PHP_INI" ] || [ ! -f "$PHP_INI" ]; then
    echo -e "${RED}โ ุฎุทุฃ: ูู ูุชู ุงูุนุซูุฑ ุนูู ููู php.ini${NC}"
    echo "ุชุฃูุฏ ูู ุชุซุจูุช PHP ุจุดูู ุตุญูุญ"
    exit 1
fi

echo -e "${GREEN}โ ุชู ุงูุนุซูุฑ ุนูู ููู php.ini:${NC} $PHP_INI"
echo ""

# ====================================
# ุงูุฎุทูุฉ 2: ุนุฑุถ ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ
# ====================================
echo -e "${BOLD}๐ ุงูุฎุทูุฉ 2: ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ...${NC}"
CURRENT_UPLOAD=$(php -r "echo ini_get('upload_max_filesize');")
CURRENT_POST=$(php -r "echo ini_get('post_max_size');")
CURRENT_EXEC=$(php -r "echo ini_get('max_execution_time');")

echo -e "  upload_max_filesize: ${YELLOW}${CURRENT_UPLOAD}${NC}"
echo -e "  post_max_size:       ${YELLOW}${CURRENT_POST}${NC}"
echo -e "  max_execution_time:  ${YELLOW}${CURRENT_EXEC}${NC}"
echo ""

# ====================================
# ุงูุฎุทูุฉ 3: ุชุฃููุฏ ุงููุชุงุจุนุฉ
# ====================================
echo -e "${BOLD}โ๏ธ  ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ ุงูุชู ุณูุชู ุชุทุจูููุง:${NC}"
echo -e "  upload_max_filesize: ${GREEN}50M${NC}"
echo -e "  post_max_size:       ${GREEN}64M${NC}"
echo -e "  max_execution_time:  ${GREEN}120${NC}"
echo ""
echo -e "${YELLOW}โ๏ธ  ุชุญุฐูุฑ: ูุฐุง ุงูุณูุฑูุจุช ุณูููู ุจุชุนุฏูู ููู php.ini${NC}"
echo -e "${YELLOW}   ุณูุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุชุนุฏูู${NC}"
echo ""
read -p "ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ (y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo -e "${RED}ุชู ุงูุฅูุบุงุก${NC}"
    exit 0
fi
echo ""

# ====================================
# ุงูุฎุทูุฉ 4: ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
# ====================================
echo -e "${BOLD}๐พ ุงูุฎุทูุฉ 3: ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ...${NC}"
BACKUP_FILE="${PHP_INI}.backup.$(date +%Y%m%d_%H%M%S)"

if sudo cp "$PHP_INI" "$BACKUP_FILE"; then
    echo -e "${GREEN}โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ:${NC} $BACKUP_FILE"
else
    echo -e "${RED}โ ูุดู ุฅูุดุงุก ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ${NC}"
    exit 1
fi
echo ""

# ====================================
# ุงูุฎุทูุฉ 5: ุชุนุฏูู php.ini ุจุงุณุชุฎุฏุงู sed
# ====================================
echo -e "${BOLD}๐ง ุงูุฎุทูุฉ 4: ุชุนุฏูู ุฅุนุฏุงุฏุงุช php.ini...${NC}"

# ุฏุงูุฉ ูุชุนุฏูู ุงููููุฉ ูู php.ini
update_php_ini() {
    local setting=$1
    local new_value=$2
    local file=$3
    
    # ุงูุจุญุซ ุนู ุงูุณุทุฑ ูุชุนุฏููู (ุณูุงุก ูุงู ูุนูู ุนููู ุฃู ูุง)
    if sudo sed -i.tmp \
        -e "s/^;\?[[:space:]]*${setting}[[:space:]]*=.*/${setting} = ${new_value}/" \
        "$file"; then
        echo -e "${GREEN}  โ ุชู ุชุญุฏูุซ ${setting} = ${new_value}${NC}"
        return 0
    else
        echo -e "${RED}  โ ูุดู ุชุญุฏูุซ ${setting}${NC}"
        return 1
    fi
}

# ุชุนุฏูู ุงูููู ุงูุซูุงุซุฉ
update_php_ini "upload_max_filesize" "50M" "$PHP_INI"
update_php_ini "post_max_size" "64M" "$PHP_INI"
update_php_ini "max_execution_time" "120" "$PHP_INI"

# ุญุฐู ุงููููุงุช ุงููุคูุชุฉ
sudo rm -f "${PHP_INI}.tmp"

echo ""

# ====================================
# ุงูุฎุทูุฉ 6: ุฅูุดุงุก ูุฌูุฏุงุช Laravel
# ====================================
echo -e "${BOLD}๐ ุงูุฎุทูุฉ 5: ุฅุนุฏุงุฏ ูุฌูุฏุงุช Laravel...${NC}"

# ุฅูุดุงุก ูุฌูุฏ livewire-tmp
if [ ! -d "storage/app/livewire-tmp" ]; then
    mkdir -p storage/app/livewire-tmp
    echo -e "${GREEN}  โ ุชู ุฅูุดุงุก storage/app/livewire-tmp${NC}"
else
    echo -e "${YELLOW}  โ ุงููุฌูุฏ storage/app/livewire-tmp ููุฌูุฏ ุจุงููุนู${NC}"
fi

# ุถุจุท ุงูุตูุงุญูุงุช
chmod -R 775 storage/app/livewire-tmp 2>/dev/null && echo -e "${GREEN}  โ ุชู ุถุจุท ุตูุงุญูุงุช livewire-tmp${NC}"
chmod -R 775 storage/app/public 2>/dev/null && echo -e "${GREEN}  โ ุชู ุถุจุท ุตูุงุญูุงุช public${NC}"
chmod -R 775 storage/logs 2>/dev/null && echo -e "${GREEN}  โ ุชู ุถุจุท ุตูุงุญูุงุช logs${NC}"

echo ""

# ====================================
# ุงูุฎุทูุฉ 7: ุงูุชุญูู ูู ุงูุชุนุฏููุงุช
# ====================================
echo -e "${BOLD}โ ุงูุฎุทูุฉ 6: ุงูุชุญูู ูู ุงูุชุนุฏููุงุช...${NC}"

# ุฅุนุงุฏุฉ ูุฑุงุกุฉ ุงูููู ุงูุฌุฏูุฏุฉ ูู php.ini ูุจุงุดุฑุฉ
NEW_UPLOAD=$(grep "^upload_max_filesize" "$PHP_INI" | cut -d'=' -f2 | xargs)
NEW_POST=$(grep "^post_max_size" "$PHP_INI" | cut -d'=' -f2 | xargs)
NEW_EXEC=$(grep "^max_execution_time" "$PHP_INI" | cut -d'=' -f2 | xargs)

echo -e "  ุงูููู ุงูุฌุฏูุฏุฉ ูู php.ini:"
echo -e "    upload_max_filesize: ${GREEN}${NEW_UPLOAD}${NC}"
echo -e "    post_max_size:       ${GREEN}${NEW_POST}${NC}"
echo -e "    max_execution_time:  ${GREEN}${NEW_EXEC}${NC}"
echo ""

# ====================================
# ุฑุณุงูุฉ ุงููุฌุงุญ ุงูููุงุฆูุฉ
# ====================================
echo -e "${BOLD}${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${BOLD}${GREEN}   โจ ุชู ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!${NC}"
echo -e "${BOLD}${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""
echo -e "${BOLD}${YELLOW}โ๏ธ  ุฎุทูุงุช ูููุฉ:${NC}"
echo -e "   ${BOLD}1.${NC} ุฃููู ุณูุฑูุฑ Laravel ุงูุญุงูู (ุงุถุบุท Ctrl+C)"
echo -e "   ${BOLD}2.${NC} ุฃุนุฏ ุชุดุบูู ุงูุณูุฑูุฑ: ${GREEN}php artisan serve${NC}"
echo -e "   ${BOLD}3.${NC} ุฌุฑูุจ ุฑูุน ุงููููุงุช ุงููุจูุฑุฉ ูู Filament"
echo ""
echo -e "${BLUE}๐ก ููุงุญุธุฉ:${NC} ุชู ุญูุธ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู:"
echo -e "   ${BACKUP_FILE}"
echo ""
echo -e "${BLUE}๐ ููุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช ุงูุฌุฏูุฏุฉ ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู:${NC}"
echo -e "   ${GREEN}php -i | grep -E \"(upload_max_filesize|post_max_size|max_execution_time)\"${NC}"
echo ""
echo -e "${BOLD}${GREEN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
