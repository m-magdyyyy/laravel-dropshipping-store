# ๐ ุชุญุฏูุซุงุช Job ูุนุงูุฌุฉ ุงูุตูุฑ - ูุดู ุงูุฃุฎุทุงุก ูุญู ูุดููุฉ ุงูุฐุงูุฑุฉ

## ๐ ุงููุดููุฉ ุงูุฃุตููุฉ

ูุงูุช ูููุฉ `OptimizeProductImages` ุชูุดู ุจุตูุช ุจุฏูู ุชุณุฌูู ุฃุฎุทุงุก ูุงุถุญุฉ ูู logsุ ููุง ูุฌุนู ุชุดุฎูุต ุงููุดุงูู ุตุนุจุงู ุฌุฏุงู.

**ุงูุฃุนุฑุงุถ:**
- โ Job ูุธูุฑ ูู `DONE` ูู terminal
- โ ูุง ุชูุฌุฏ ูููุงุช ุตูุฑ ูุญุณููุฉ ูู storage
- โ ููู `laravel.log` ูุงุฑุบ ุชูุงูุงู
- โ ูุง ููุฌุฏ ุฃู ูุนูููุงุช ุนู ุณุจุจ ุงููุดู

**ุงูุณุจุจ ุงููุญุชูู:**
- ููุงุฏ ุงูุฐุงูุฑุฉ (Out of Memory) ุนูุฏ ูุนุงูุฌุฉ ุตูุฑ ูุจูุฑุฉ
- ุงูุฃุฎุทุงุก ูุญุฌูุจุฉ ุฏุงุฎู ูุชู `try...catch`

---

## โ ุงูุชุญุฏูุซุงุช ุงูููููุฐุฉ

### 1. ุฒูุงุฏุฉ ุญุฏ ุงูุฐุงูุฑุฉ โก
```php
// ูู ุจุฏุงูุฉ handle()
ini_set('memory_limit', '512M');
```

**ุงูููุงุฆุฏ:**
- โ ูุฒูุฏ ุงูุฐุงูุฑุฉ ูุคูุชุงู **ููุฐู ุงููููุฉ ููุท**
- โ ูุง ูุคุซุฑ ุนูู ุจุงูู ุงูุชุทุจูู
- โ ูุณูุญ ุจูุนุงูุฌุฉ ุตูุฑ ุฃูุจุฑ ุญุฌูุงู
- โ ุญู ูุจุงุดุฑ ููุดููุฉ Out of Memory

---

### 2. ุชุณุฌูู ุจุฏุงูุฉ ุงูุชูููุฐ ๐
```php
Log::info('OptimizeProductImages: Starting optimization', [
    'product_id' => $this->productId,
    'memory_limit' => ini_get('memory_limit'),
    'memory_usage' => round(memory_get_usage(true) / 1024 / 1024, 2) . 'MB',
]);
```

**ุงููุนูููุงุช ุงููุณุฌูุฉ:**
- ูุนุฑู ุงูููุชุฌ
- ุญุฏ ุงูุฐุงูุฑุฉ ุงููุชุงุญ
- ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุงูุญุงูู

---

### 3. ุชุณุฌูู ููุตูู ููุฃุฎุทุงุก ๐

#### ูุจู ุงูุชุนุฏูู:
```php
catch (\Throwable $e) {
    Log::warning('OptimizeProductImages main image failed', [
        'product_id' => $product->id,
        'error' => $e->getMessage(),
    ]);
}
```

#### ุจุนุฏ ุงูุชุนุฏูู:
```php
catch (\Throwable $e) {
    Log::error('OptimizeProductImages: main image processing failed', [
        'product_id' => $product->id,
        'image_path' => $path,
        'error_message' => $e->getMessage(),
        'error_code' => $e->getCode(),
        'error_file' => $e->getFile(),
        'error_line' => $e->getLine(),
        'error_trace' => $e->getTraceAsString(),
        'memory_usage' => round(memory_get_usage(true) / 1024 / 1024, 2) . 'MB',
        'memory_peak' => round(memory_get_peak_usage(true) / 1024 / 1024, 2) . 'MB',
    ]);
}
```

**ุงููุนูููุงุช ุงูุฅุถุงููุฉ:**
- โ ุฑุณุงูุฉ ุงูุฎุทุฃ ุงููุงููุฉ
- โ ููุฏ ุงูุฎุทุฃ
- โ ุงูููู ุงูุฐู ุญุฏุซ ููู ุงูุฎุทุฃ
- โ ุฑูู ุงูุณุทุฑ
- โ **Stack trace ูุงูู** (ุฃูู ุฅุถุงูุฉ!)
- โ ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ุงูุญุงูู
- โ ุฐุฑูุฉ ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ

---

### 4. ุชุณุฌูู ูุฌุงุญ ุงูุชูููุฐ โ
```php
Log::info('OptimizeProductImages: Completed successfully', [
    'product_id' => $product->id,
    'memory_peak' => round(memory_get_peak_usage(true) / 1024 / 1024, 2) . 'MB',
]);
```

**ุงููุงุฆุฏุฉ:**
- ูุนุฑูุฉ ุฃู Job ุงูุชูู ุจูุฌุงุญ ูุนูุงู
- ูุนุฑูุฉ ุฃูุตู ุฐุงูุฑุฉ ุชู ุงุณุชุฎุฏุงููุง

---

## ๐ ูุซุงู ุนูู ุงูุณุฌูุงุช ุงูุฌุฏูุฏุฉ

### ุนูุฏ ุงูุจุฏุงูุฉ:
```json
[2025-10-18 14:30:00] local.INFO: OptimizeProductImages: Starting optimization
{
    "product_id": 5,
    "memory_limit": "512M",
    "memory_usage": "45.32MB"
}
```

### ุนูุฏ ุญุฏูุซ ุฎุทุฃ:
```json
[2025-10-18 14:30:05] local.ERROR: OptimizeProductImages: main image processing failed
{
    "product_id": 5,
    "image_path": "products/large-image.jpg",
    "error_message": "Allowed memory size of 134217728 bytes exhausted",
    "error_code": 0,
    "error_file": "/vendor/intervention/image/src/Image.php",
    "error_line": 145,
    "error_trace": "#0 /app/Jobs/OptimizeProductImages.php(95): Intervention\\Image\\Image->read()\n#1 ...",
    "memory_usage": "512.00MB",
    "memory_peak": "512.00MB"
}
```

### ุนูุฏ ุงููุฌุงุญ:
```json
[2025-10-18 14:30:10] local.INFO: OptimizeProductImages: Completed successfully
{
    "product_id": 5,
    "memory_peak": "234.56MB"
}
```

---

## ๐ง ููููุฉ ุงูุชุดุฎูุต ุงูุขู

### 1. ูุฑุงูุจุฉ ุงูุณุฌูุงุช
```bash
# ูู terminal ูููุตู
tail -f storage/logs/laravel.log
```

### 2. ุชุดุบูู Job
```bash
php artisan tinker
>>> \App\Jobs\OptimizeProductImages::dispatch(5);
```

### 3. ูุฑุงุกุฉ ุงููุชุงุฆุฌ
ุณุชุฌุฏ **ูุนูููุงุช ููุตูุฉ ุฌุฏุงู** ุนู:
- โ ูุชู ุจุฏุฃ Job
- โ ูุง ูู ุงูุฐุงูุฑุฉ ุงููุชุงุญุฉ
- โ ุฅุฐุง ุญุฏุซ ุฎุทุฃุ ุณุชุนุฑู:
  - ุฑุณุงูุฉ ุงูุฎุทุฃ ุงูุฏูููุฉ
  - ููุงู ุงูุฎุทุฃ ุจุงูุถุจุท (ููู + ุณุทุฑ)
  - Stack trace ูุงูู
  - ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ูุญุธุฉ ุงูุฎุทุฃ
- โ ูุชู ุงูุชูู ุจูุฌุงุญ
- โ ุฃูุตู ุฐุงูุฑุฉ ุชู ุงุณุชุฎุฏุงููุง

---

## ๐ฏ ุญููู ุฅุถุงููุฉ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### ุฅุฐุง ูุงูุช ุงููุดููุฉ: Out of Memory

#### ุงูุญู 1: ุฒูุงุฏุฉ ุงูุฐุงูุฑุฉ ุฃูุซุฑ
```php
// ูู handle()
ini_set('memory_limit', '1024M'); // 1GB ุจุฏูุงู ูู 512MB
```

#### ุงูุญู 2: ุชูููู ุญุฌู ุงูุตูุฑ ุงููุนุงูุฌุฉ
```php
// ูู handle()
->scaleDown(width: 800)  // ุจุฏูุงู ูู 1200
```

#### ุงูุญู 3: ุชุญุฑูุฑ ุงูุฐุงูุฑุฉ ุจูู ุงูุนูููุงุช
```php
// ุจุนุฏ ูุนุงูุฌุฉ ูู ุตูุฑุฉ
unset($img, $thumb, $imageData);
gc_collect_cycles(); // ุชุดุบูู Garbage Collector
```

---

### ุฅุฐุง ูุงูุช ุงููุดููุฉ: GD Library

ุจุนุถ ุงูุตูุฑ ุชุญุชุงุฌ Imagick ุจุฏูุงู ูู GD:

```php
use Intervention\Image\Drivers\Imagick\Driver;

$manager = new ImageManager(new Driver());
```

---

### ุฅุฐุง ูุงูุช ุงููุดููุฉ: Timeout

```php
// ูู handle()
set_time_limit(300); // 5 ุฏูุงุฆู
```

---

## ๐ ุงูุฎูุงุตุฉ

### ูุง ุชู ุชุญุณููู:
1. โ **ุฒูุงุฏุฉ ุงูุฐุงูุฑุฉ** ุฅูู 512M ูุคูุชุงู
2. โ **ุชุณุฌูู ุชูุตููู** ููู ุฎุทุฃ ูุน Stack Trace
3. โ **ุชุณุฌูู ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ** ูู ูู ูุฑุญูุฉ
4. โ **ุชุณุฌูู ุจุฏุงูุฉ ูููุงูุฉ** ุงูุชูููุฐ
5. โ ุชุบููุฑ `Log::warning` ุฅูู `Log::error` ููุฃุฎุทุงุก ุงูุญููููุฉ

### ุงูููุงุฆุฏ:
- ๐ **ุชุดุฎูุต ุฏููู** ูุฃู ูุดููุฉ
- โก **ุญู ูุจุงุดุฑ** ููุดููุฉ ุงูุฐุงูุฑุฉ
- ๐ **ูุฑุงูุจุฉ ูุงุถุญุฉ** ูุฃุฏุงุก Job
- ๐๏ธ **ูุนูููุงุช ูุงููุฉ** ูุญู ุฃู ุฎุทุฃ ูุณุชูุจูู

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1. ุงุฎุชุจุงุฑ ุงูุชุนุฏููุงุช
```bash
# ุดุบูู Queue Worker
php artisan queue:work

# ูู terminal ุขุฎุฑุ ุฑุงูุจ ุงูุณุฌูุงุช
tail -f storage/logs/laravel.log

# ูู terminal ุซุงูุซุ ุงุฎุชุจุฑ Job
php artisan tinker
>>> \App\Jobs\OptimizeProductImages::dispatch(PRODUCT_ID);
```

### 2. ูุฑุงูุจุฉ ุงููุชุงุฆุฌ
- ุชุญูู ูู ุงูุณุฌูุงุช
- ุงุจุญุซ ุนู ุฃู ุฑุณุงุฆู `ERROR`
- ุงูุฑุฃ Stack Trace ูููู ุงููุดููุฉ

### 3. ุชุทุจูู ุงูุญููู ุงูุฅุถุงููุฉ
ุจูุงุกู ุนูู ููุน ุงูุฎุทุฃ ุงูููุชุดู

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ:** 18 ุฃูุชูุจุฑ 2025  
**ุงูุฅุตุฏุงุฑ:** 2.1 (ูุดู ุงูุฃุฎุทุงุก + ุญู ุงูุฐุงูุฑุฉ)
